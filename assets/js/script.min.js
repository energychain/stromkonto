$(document).ready(function() {
    $('.iot').iot();
});
$.qparam = function (name) {
    var results = new RegExp('[\?&]' + name + '=([^&#]*)')
                      .exec(window.location.search);

    return (results !== null) ? results[1] || 0 : false;
}

function resolvAddress(address) {
    if(address=="0x445c1e284c15a50a69fe7d6dcd9fba3b938b52bb") return "Corrently Erzeugung";
    if(address=="0xdcbab2b1c28b6f57c367f4eff0f5c7893400cc4d") return "Corrently Gr√ºnstrombonus";
    return address;
}

let stromkonto_data= {};
let stromkonto_txs = [];
let bc_status = {};

function initVue()  {
  let view = new Vue({
        el: '#app',
        data: stromkonto_data});
  $('#app').attr("initialized","true");
  $('.appcontent').show();
                
}
function initBCStatus() {
    bc_status.blocktime="";
    bc_status.blocknumber = "";
    
    let view = new Vue({
        el: '#bcstatus',
        data: bc_status});
    $('#bcstatus').attr("initialized","true");    
    setInterval(updateBCStatus,15000);
    updateBCStatus();
}

function updateBCStatus() {
    let wallet = new CorrentlyWallet.default.Wallet.createRandom();
    wallet.provider = new CorrentlyWallet.default.providers.JsonRpcProvider("https://node.corrently.io/", { chainId: 42 });
    wallet.provider.getBlockNumber().then(function(l) { 
            bc_status.blocknumber=l;
    } );
}
function gsiTable() {
    var html="";
    if(typeof stromkonto_data.account.gsi == "undefined") return;
    if(typeof stromkonto_data.account.gsi.forecast == "undefined") return;
    if(typeof stromkonto_data.account.gsi.bonus == "undefined") return;
    
    html+="<table class='table table-sm table-responsive' style='margin:0px;'>";
    let row_time="<td class='bg-secondary text-light'>Zeit</td>";
    let row_bonus="<td>Cent/kWh</td>";
    
    for(var i=0;i<stromkonto_data.account.gsi.forecast.length;i++) {
        let item=stromkonto_data.account.gsi.forecast[i];
        let ts=item.epochtime*1000;
        if(ts>new Date().getTime()) {
            if(item.eevalue < 30) row_bonus+="<td class='bg-danger'  title='"+item.eevalue+"%'>"; else
            if(item.eevalue > 70) row_bonus+="<td class='bg-success'  title='"+item.eevalue+"%'>"; else
            row_bonus+="<td class='bg-warning' title='"+item.eevalue+"%'>";
            row_bonus+=(stromkonto_data.account.gsi.bonus*item.eevalue).toFixed(2);
            row_bonus+="</td>";
            row_time+="<td class='bg-secondary text-light' title='"+new Date(ts).toLocaleString()+"'>";
            row_time+=new Date(ts).getHours()+":00";
            row_time+="</td>";            
        }
    }    
    html+="<tr>"+row_time+"</tr>";
    html+="<tr>"+row_bonus+"</tr>";
    html+="</table>";
    $('#gsi').html(html);
    $('#gsi').show();
    $('#gsi_card').show();
}
function openAccount() {    
    window.localStorage.setItem("lastAddress",$('#account').val());
    CorrentlyWallet.default.Stromkonto($('#account').val()).then(function(l) { 
        CorrentlyWallet.default.CorrentlyAccount($('#account').val()).then(function(account) {
                stromkonto_data = l.result;
                stromkonto_data.account = account;
                stromkonto_data.txs = stromkonto_txs;
                if( $('#app').attr("initialized")!="true") initVue();
                $('#app').show();    
                txVue();
                gsiTable();
                setTimeout(openAccount,31000);
        });
    });            
}

function txVue() {
    let wallet = new CorrentlyWallet.default.Wallet.createRandom();
    wallet.provider = new CorrentlyWallet.default.providers.JsonRpcProvider("https://node.corrently.io/", { chainId: 42 });
    wallet.provider.getBlockNumber().then(function(latest_block) {
                let mytxs=[];
                wallet.provider.getLogs({address:"0x8e93e70d8ac18dbaa38dd557acd4901f843e04e3",fromBlock:latest_block-15000,topics:["0x1a71774309711c9c0f58692353c6a0789dbdc71f63e2e42a190ab9bc03f79250"]}).then(function(l) {
                    l=l.reverse();
                    for(var i=0;i<l.length;i++) {
                        let item = l[i];                        
                        item.data = item.data.substr(2);
                        item.from = "0x"+item.data.substr(24,40);
                        item.to = "0x"+item.data.substr(88,40);
                        item.value = parseInt(item.data.substr(128,64),16)/100000;
                        item.base = parseInt(item.data.substr(192,64),16)/1000;            
                        l[i]=item;
                        if((item.from == $('#account').val().toLowerCase())||(item.to == $('#account').val().toLowerCase())) {
                            if((item.from == $('#account').val().toLowerCase())) {
                               item.peer = item.to; 
                               item.value_abs = item.value*-1;
                               item.base_abs = item.base*-1;
                               }
                               else {
                               item.peer = item.from;
                               item.value_abs = item.value;
                               item.base_abs = item.base;
                               }    
                            item.value_abs = (item.value_abs.toFixed(5)+"").replace('.',',');
                            item.base_abs = (item.base_abs.toFixed(3)+"").replace('.',',');
                            if(item.peer=="0x445c1e284c15a50a69fe7d6dcd9fba3b938b52bb") item.base_abs="/";
                            item.peer=resolvAddress(item.peer);                                               
                            mytxs.push(item);
                        }
                    }
                    stromkonto_txs=mytxs;
                    stromkonto_data.txs = mytxs;
                });
    });
    
}
$(document).ready(function() {
    $('#app').hide();
    $('#gsi').hide();
    initBCStatus();
    if($.qparam("a")) {
        $('#account').val($.qparam("a"));
    } else {
        if(window.localStorage.getItem("privateKey")) {
           let lwallet = new CorrentlyWallet.default.Wallet(window.localStorage.getItem("privateKey"));
            $('#account').val(lwallet.address);
        } else {
            if(window.localStorage.getItem("lastAddress")) {
                $('#account').val(window.localStorage.getItem("lastAddress"));
            } else {
                let lwallet = CorrentlyWallet.default.Wallet.createRandom();
                $('#account').val(lwallet.address);
            }
        }
    }
    $('#btn_open').click(openAccount);
    openAccount();    
});
