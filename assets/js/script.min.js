$(document).ready(function() {
    $('.iot').iot();
});
$.qparam = function (name) {
    var results = new RegExp('[\?&]' + name + '=([^&#]*)')
                      .exec(window.location.search);

    return (results !== null) ? results[1] || 0 : false;
}

function resolvAddress(address) {    if(address=="0x445c1e284c15a50a69fe7d6dcd9fba3b938b52bb") return "Eigenerzeugung";
    if(address=="0xdcbab2b1c28b6f57c367f4eff0f5c7893400cc4d") return "Gr√ºnstrombonus";
    return address;
}

let stromkonto_data= {};
let stromkonto_txs = [];
let bc_status = {};

function initVue()  {
  $('#frm_panel').hide();
  let view = new Vue({
        el: '#app',
        data: stromkonto_data});
  $('#app').attr("initialized","true");
  $('.appcontent').show();      
                
}
function initBCStatus() {
    bc_status.blocktime="";
    bc_status.blocknumber = "";
    
    let view = new Vue({
        el: '#bcstatus',
        data: bc_status});
    $('#bcstatus').attr("initialized","true");    
    setInterval(updateBCStatus,15000);
    updateBCStatus();
}

function updateBCStatus() {    
    let wallet = new CorrentlyWallet.default.Wallet(CorrentlyWallet.default.Wallet.createRandom().privateKey,new CorrentlyWallet.default.providers.JsonRpcProvider("https://node.corrently.io/", { chainId: 42 }));    
    wallet.provider.getBlockNumber().then(function(l) { 
            bc_status.blocknumber=l;
    } );
}
function gsiTable() {
    var html="";
    if(typeof stromkonto_data.account.gsi == "undefined") return;
    if(typeof stromkonto_data.account.gsi.forecast == "undefined") return;
    if(typeof stromkonto_data.account.gsi.bonus == "undefined") return;
    
    html+="<table class='table table-sm table-responsive' style='margin:0px;'>";
    let row_time="<td class='bg-secondary text-light'>Zeit</td>";
    let row_bonus="<td>Cent/kWh</td>";
    
    for(var i=0;i<stromkonto_data.account.gsi.forecast.length;i++) {
        let item=stromkonto_data.account.gsi.forecast[i];
        let ts=item.epochtime*1000;
        if(ts>new Date().getTime()) {
            if(item.eevalue < 30) row_bonus+="<td class='bg-danger'  title='"+item.eevalue+"%'>"; else
            if(item.eevalue > 70) row_bonus+="<td class='bg-success'  title='"+item.eevalue+"%'>"; else
            row_bonus+="<td class='bg-warning' title='"+item.eevalue+"%'>";
            row_bonus+=(stromkonto_data.account.gsi.bonus*item.eevalue).toFixed(2);
            row_bonus+="</td>";
            row_time+="<td class='bg-secondary text-light' title='"+new Date(ts).toLocaleString()+"'>";
            row_time+=new Date(ts).getHours()+":00";
            row_time+="</td>";            
        }
    }    
    html+="<tr>"+row_time+"</tr>";
    html+="<tr>"+row_bonus+"</tr>";
    html+="</table>";
    $('#gsi').html(html);
    $('#gsi').show();
    $('#gsi_card').show();
}

function timeStamp(blockNumber) {
    let ts = window.localStorage.getItem("ts_"+blockNumber);
    if(ts==null) {
        let provider = new CorrentlyWallet.default.providers.JsonRpcProvider('https://node.corrently.io/', { chainId: 42 });
        provider.getBlock(blockNumber).then(function(bi) {
            ts = bi.timestamp;
            window.localStorage.setItem("ts_"+blockNumber,ts);
            for(var i=0;i<stromkonto_data.txs.length;i++) {
                if(stromkonto_data.txs[i].blockNumber==blockNumber) {
                    stromkonto_data.txs[i].timeStamp=new Date(ts*1000).toLocaleString();
                }
            }
        });
        return "#"+blockNumber;
    } else return new Date(ts*1000).toLocaleString();
}

function openAccount() {    
    $('#account_nr').html($('#account').val());
    if(($('#account_alias').val()+"").length>0) {
        window.localStorage.setItem("alias_"+$('#account_alias').val(),$('#account').val());
    }
    if(($('#account').val()+"").length!=42) {
    $('#account').val(window.localStorage.getItem("alias_"+$('#account').val()));
    }
    window.localStorage.setItem("lastAddress",$('#account').val());
    CorrentlyWallet.default.Stromkonto($('#account').val()).then(function(l) { 
        CorrentlyWallet.default.CorrentlyAccount($('#account').val()).then(function(account) {
                stromkonto_data = l.result;
                stromkonto_data.account = account;
                if(typeof stromkonto_data.account.clearedGeneration != "undefined") {
                    stromkonto_data.generation_3f=stromkonto_data.account.clearedGeneration.toFixed(3).replace('.',',');
                } else {
                    stromkonto_data.generation_3f=0;
                }
                stromkonto_data.txs = stromkonto_txs;
                if( $('#app').attr("initialized")!="true") initVue();
                if(typeof l.transactions == "function") {
                    l.transactions().then(function(mytxs) {
                        for(var i=0; i<mytxs.length;i++) {
                            mytxs[i].peer = resolvAddress(mytxs[i].peer);                                             mytxs[i].timeStamp =  timeStamp(mytxs[i].blockNumber);                 
                        }
                        stromkonto_txs = mytxs;
                        stromkonto_data.txs = mytxs;                    
                    });
                }
                $('#app').show();                    
                gsiTable();
                setTimeout(openAccount,31000);
        });
    });            
}

$(document).ready(function() {
    $('#app').hide();
    $('#gsi').hide();
    initBCStatus();
    if($.qparam("a")) {
        $('#account').val($.qparam("a"));
    } else {
        if(window.localStorage.getItem("privateKey")) {
           let lwallet = new CorrentlyWallet.default.Wallet(window.localStorage.getItem("privateKey"));
            $('#account').val(lwallet.address);
        } else {
            if(window.localStorage.getItem("lastAddress")) {
                $('#account').val(window.localStorage.getItem("lastAddress"));
            } else {
                let lwallet = CorrentlyWallet.default.Wallet.createRandom();
                $('#account').val(lwallet.address);
            }
        }
    }
    $('#btn_open').click(openAccount);
    openAccount();    
    $('#btn_change').click(function() {
       $('#frm_panel').show();        
       $('.appcontent').hide();
    });
});
